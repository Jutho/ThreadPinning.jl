<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Pinning Julia Threads · ThreadPinning.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ThreadPinning.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ThreadPinning.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">ThreadPinning</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Pinning Julia Threads</a><ul class="internal"><li><a class="tocitem" href="#Interactive-usage"><span>Interactive usage</span></a></li><li><a class="tocitem" href="#Non-interactive-usage"><span>Non-interactive usage</span></a></li><li><a class="tocitem" href="#Manual-pinning"><span>Manual pinning</span></a></li><li><a class="tocitem" href="#Default-pinning-(for-packages)"><span>Default pinning (for packages)</span></a></li><li><a class="tocitem" href="#Unpinning"><span>Unpinning</span></a></li></ul></li><li><a class="tocitem" href="../ex_blas/">Autochecking BLAS Thread Settings</a></li><li><a class="tocitem" href="../ex_core2core_latency/">Measuring Core-to-Core Latency</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Explanations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanations/why/">Why Pin Julia Threads?</a></li><li><a class="tocitem" href="../../explanations/blas/">Julia Threads + BLAS Threads</a></li><li><a class="tocitem" href="../../explanations/how/">How It Works</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">References</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../refs/api/">API</a></li><li><a class="tocitem" href="../../refs/latency/">Latency</a></li><li><a class="tocitem" href="../../refs/prefs/">Preferences</a></li><li><a class="tocitem" href="../../refs/libX/">LibX</a></li><li><a class="tocitem" href="../../refs/utility/">Utility</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Pinning Julia Threads</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Pinning Julia Threads</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/carstenbauer/ThreadPinning.jl/blob/main/docs/src/examples/ex_pinning_julia_threads.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Pinning-Julia-Threads"><a class="docs-heading-anchor" href="#Pinning-Julia-Threads">Pinning Julia Threads</a><a id="Pinning-Julia-Threads-1"></a><a class="docs-heading-anchor-permalink" href="#Pinning-Julia-Threads" title="Permalink"></a></h1><p>Generally speaking, the most important functions are <a href="../../refs/api/#ThreadPinning.pinthreads-Tuple{AbstractVector{&lt;:Integer}}"><code>pinthreads</code></a> and <a href="../../refs/api/#ThreadPinning.threadinfo-Tuple{}"><code>threadinfo</code></a>.</p><h2 id="Interactive-usage"><a class="docs-heading-anchor" href="#Interactive-usage">Interactive usage</a><a id="Interactive-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Interactive-usage" title="Permalink"></a></h2><p>Below, we consider a dual-socket system where each CPU has 20 hardware threads and start julia with 20 threads, i.e. <code>julia -t 20</code>.</p><h3 id="colortrue-(default)"><a class="docs-heading-anchor" href="#colortrue-(default)"><code>color=true</code> (default)</a><a id="colortrue-(default)-1"></a><a class="docs-heading-anchor-permalink" href="#colortrue-(default)" title="Permalink"></a></h3><p><img src="../threadinfo_noht.png" alt="threadinfo_noht.png"/></p><h3 id="colorfalse"><a class="docs-heading-anchor" href="#colorfalse"><code>color=false</code></a><a id="colorfalse-1"></a><a class="docs-heading-anchor-permalink" href="#colorfalse" title="Permalink"></a></h3><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using ThreadPinning</code><code class="nohighlight hljs ansi" style="display:block;"></code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; threadinfo(; color=false)</code><code class="nohighlight hljs ansi" style="display:block;">
| 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,
  16,17,18,19 |
| _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,
  _,_,_,_ |

# = Julia thread, | = Socket seperator

Julia threads: 20
├ Occupied CPU-threads: 20
└ Mapping (Thread =&gt; CPUID): 1 =&gt; 19, 2 =&gt; 18, 3 =&gt; 0, 4 =&gt; 1, 5 =&gt; 4, ...</code></pre><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pinthreads(:compact)</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; threadinfo(; color=false)</code><code class="nohighlight hljs ansi" style="display:block;">
| 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,
  16,17,18,19 |
| _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,
  _,_,_,_ |

# = Julia thread, | = Socket seperator

Julia threads: 20
├ Occupied CPU-threads: 20
└ Mapping (Thread =&gt; CPUID): 1 =&gt; 0, 2 =&gt; 1, 3 =&gt; 2, 4 =&gt; 3, 5 =&gt; 4, ...</code></pre><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pinthreads(:spread)</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; threadinfo(; color=false)</code><code class="nohighlight hljs ansi" style="display:block;">
| 0,1,2,3,4,5,6,7,8,9,_,_,_,_,_,_,
  _,_,_,_ |
| 20,21,22,23,24,25,26,27,28,29,_,_,_,_,_,_,
  _,_,_,_ |

# = Julia thread, | = Socket seperator

Julia threads: 20
├ Occupied CPU-threads: 20
└ Mapping (Thread =&gt; CPUID): 1 =&gt; 0, 2 =&gt; 20, 3 =&gt; 1, 4 =&gt; 21, 5 =&gt; 2, ...</code></pre><h3 id="Hyperthreads"><a class="docs-heading-anchor" href="#Hyperthreads">Hyperthreads</a><a id="Hyperthreads-1"></a><a class="docs-heading-anchor-permalink" href="#Hyperthreads" title="Permalink"></a></h3><p>On a system where hyperthreading is enabled, you will get something like the following (with <code>color=true</code>). Below, we consider a dual-socket system where each CPU has 128 hardware threads (64 CPU-cores + hyperthreading) and start julia with 40 threads, i.e. <code>julia -t 40</code>.</p><p><img src="../threadinfo.png" alt="threadinfo.png"/></p><p>Note that hyperthreads are highlighted with a different color since often times you want to avoid pinning Julia threads to them (of course, there are exceptions).</p><h2 id="Non-interactive-usage"><a class="docs-heading-anchor" href="#Non-interactive-usage">Non-interactive usage</a><a id="Non-interactive-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Non-interactive-usage" title="Permalink"></a></h2><h3 id="envvars"><a class="docs-heading-anchor" href="#envvars">Environment variables</a><a id="envvars-1"></a><a class="docs-heading-anchor-permalink" href="#envvars" title="Permalink"></a></h3><p>The following environment variables can be used to specify the desired pinning before starting Julia. Julia Threads will then automatically get pinned during the initialization of the ThreadPinning package, i.e. when calling <code>using ThreadPinning</code>.</p><ul><li><code>JULIA_PIN</code>: Can be set to any binding / pinning strategy symbol supported by <a href="../../refs/api/#ThreadPinning.pinthreads-Tuple{AbstractVector{&lt;:Integer}}"><code>pinthreads</code></a>, e.g. <code>JULIA_PIN=compact</code>.</li><li><code>JULIA_PLACES</code> (optional): Can be set to any places symbol supported by <a href="../../refs/api/#ThreadPinning.pinthreads-Tuple{AbstractVector{&lt;:Integer}}"><code>pinthreads</code></a>, e.g. <code>JULIA_PLACES=sockets</code>. Note that explicit <code>pinthreads</code> statements take precedence over these environment variables.</li></ul><h3 id="prefs"><a class="docs-heading-anchor" href="#prefs">Julia preferences</a><a id="prefs-1"></a><a class="docs-heading-anchor-permalink" href="#prefs" title="Permalink"></a></h3><p>You can more permanently specify a certain pinning setup on a per-project basis via <a href="https://github.com/JuliaPackaging/Preferences.jl">preferences</a>. ThreadPinning.jl provides the relevant functionality in the <a href="../../refs/prefs/#Preferences"><code>ThreadPinning.Prefs</code> module</a>. Note that environment variables and explicit <code>pinthreads</code> statements take precedence over these preferences.</p><h4 id="Speed-up-package-loading-(autoupdate)"><a class="docs-heading-anchor" href="#Speed-up-package-loading-(autoupdate)">Speed up package loading (autoupdate)</a><a id="Speed-up-package-loading-(autoupdate)-1"></a><a class="docs-heading-anchor-permalink" href="#Speed-up-package-loading-(autoupdate)" title="Permalink"></a></h4><p>By default, ThreadPinning.jl queries the system topology using <code>lscpu</code> on startup (i.e. at runtime). This is quite costly but is unfortunately necessary since you might have precompiled the package on one machine and use it from another (think e.g. login and compute nodes of a HPC cluster). However, you can tell ThreadPinning.jl to permanently skip this autoupdate at runtime and to always use the system topology that was present at compile time (i.e. when precompiling the package). This is perfectly save if, e.g., you use the package on your local desktop or laptop only and can reduce the package load time significantly. To do so, simply call <code>ThreadPinning.Prefs.set_autoupdate(false)</code>.</p><h2 id="Manual-pinning"><a class="docs-heading-anchor" href="#Manual-pinning">Manual pinning</a><a id="Manual-pinning-1"></a><a class="docs-heading-anchor-permalink" href="#Manual-pinning" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>While we enumerate Julia threads as <code>1:Threads.nthreads()</code>, <strong>cpuids start from zero</strong> and are hence (typically) enumerated as <code>0:Sys.CPU_THREADS-1</code>!</p></div></div><p>Apart from the general pinning strategies like e.g. <code>:compact</code> or <code>:spread</code> you can use <a href="../../refs/api/#ThreadPinning.pinthreads-Tuple{AbstractVector{&lt;:Integer}}"><code>pinthreads(::AbstractVector{&lt;:Integer})</code></a> to pin Julia threads to specific cores.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pinthreads(5:5+Threads.nthreads()-1)</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; threadinfo(; color=false)</code><code class="nohighlight hljs ansi" style="display:block;">
| _,_,_,_,_,5,6,7,8,9,10,11,12,13,14,15,
  16,17,18,19 |
| 20,21,22,23,24,_,_,_,_,_,_,_,_,_,_,_,
  _,_,_,_ |

# = Julia thread, | = Socket seperator

Julia threads: 20
├ Occupied CPU-threads: 20
└ Mapping (Thread =&gt; CPUID): 1 =&gt; 5, 2 =&gt; 6, 3 =&gt; 7, 4 =&gt; 8, 5 =&gt; 9, ...</code></pre><p>Furthermore, if you want to pin threads individually, there is <a href="../../refs/api/#ThreadPinning.pinthread-Tuple{Integer, Integer}"><code>pinthread(threadid, cpuid)</code></a></p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pinthread(1,39)</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; threadinfo(; color=false)</code><code class="nohighlight hljs ansi" style="display:block;">
| _,_,_,_,_,_,6,7,8,9,10,11,12,13,14,15,
  16,17,18,19 |
| 20,21,22,23,24,_,_,_,_,_,_,_,_,_,_,_,
  _,_,_,39 |

# = Julia thread, | = Socket seperator

Julia threads: 20
├ Occupied CPU-threads: 20
└ Mapping (Thread =&gt; CPUID): 1 =&gt; 39, 2 =&gt; 6, 3 =&gt; 7, 4 =&gt; 8, 5 =&gt; 9, ...</code></pre><p>If you want to pin the calling thread you can simply use <a href="../../refs/api/#ThreadPinning.pinthread-Tuple{Integer, Integer}"><code>pinthread(cpuid)</code></a>.</p><h2 id="Default-pinning-(for-packages)"><a class="docs-heading-anchor" href="#Default-pinning-(for-packages)">Default pinning (for packages)</a><a id="Default-pinning-(for-packages)-1"></a><a class="docs-heading-anchor-permalink" href="#Default-pinning-(for-packages)" title="Permalink"></a></h2><p>If you&#39;re developing a package you may want to provide a reasonable default pinning. If you would naively use <code>pinthreads</code> for this you would enforce a certain pinning irrespective of what the user might have specified manually. This is because <code>pinthreads</code> by default has the highest precedence. To lower the latter you can set <code>force=false</code>, e.g. <code>pinthreads(:compact; force=false)</code>. This way, a user can overwrite your default pinning (<code>:compact</code> in this example) by using <a href="#envvars">environment variables</a>, <a href="#prefs">preferences</a>, or calling <code>pinthreads</code> manually before running your package code.</p><h2 id="Unpinning"><a class="docs-heading-anchor" href="#Unpinning">Unpinning</a><a id="Unpinning-1"></a><a class="docs-heading-anchor-permalink" href="#Unpinning" title="Permalink"></a></h2><p>We provide functions <a href="../../refs/api/#ThreadPinning.unpinthread-Tuple{Integer}"><code>unpinthread(threadid)</code></a> and <a href="../../refs/api/#ThreadPinning.unpinthreads-Tuple{}"><code>unpinthreads()</code></a> to unpin a specific or all Julia threads, respectively. This is realized by setting the thread affinity mask to all ones.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« ThreadPinning</a><a class="docs-footer-nextpage" href="../ex_blas/">Autochecking BLAS Thread Settings »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 12 December 2022 11:41">Monday 12 December 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
